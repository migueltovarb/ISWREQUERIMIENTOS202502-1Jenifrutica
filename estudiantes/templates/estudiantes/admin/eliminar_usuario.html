{% extends 'estudiantes/base.html' %}

{% block title %}Eliminar Usuario{% endblock %}

{% block content %}
<div class="fade-in">
    <h2 style="color: #dc3545; margin-bottom: 2rem;">⚠️ Eliminar Usuario</h2>
    
    <div class="card">
        <div class="card-header" style="background-color: #f8d7da; color: #721c24; border-left: 5px solid #dc3545;">
            <h3 style="margin: 0;">Confirmación de Eliminación</h3>
        </div>
        <div class="card-body">
            <div style="background-color: #fff3cd; border-left: 5px solid #ffc107; padding: 1.5rem; border-radius: 5px; margin-bottom: 2rem;">
                <p style="color: #856404; margin: 0; font-size: 1.1rem; font-weight: 500;">
                    <strong> ADVERTENCIA:</strong> Esta acción desactivará el usuario del sistema. 
                    El usuario no podrá iniciar sesión, pero su historial se mantendrá.
                </p>
            </div>
            
            <!-- Información del usuario -->
            <div style="background-color: #f8f9fa; padding: 2rem; border-radius: 10px; margin-bottom: 2rem; border-left: 5px solid #6B9BD1;">
                <h4 style="color: #1B3C53; margin-bottom: 1.5rem;"> Información del Usuario</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <div>
                        <strong style="color: #1B3C53;">Nombre Completo:</strong><br>
                        <span style="font-size: 1.2rem; color: #333;">{{ usuario.first_name }} {{ usuario.last_name }}</span>
                    </div>
                    <div>
                        <strong style="color: #1B3C53;">Usuario:</strong><br>
                        <span style="color: #666;">{{ usuario.username }}</span>
                    </div>
                    <div>
                        <strong style="color: #1B3C53;">Email:</strong><br>
                        <span style="color: #666;">{{ usuario.email }}</span>
                    </div>
                    <div>
                        <strong style="color: #1B3C53;">Rol:</strong><br>
                        <span style="background-color: 
                            {% if usuario.rol == 'estudiante' %}#6B9BD1
                            {% elif usuario.rol == 'profesor' %}#D2C1B6
                            {% else %}#1B3C53{% endif %}; 
                            color: white; padding: 0.25rem 0.75rem; border-radius: 15px; font-weight: bold;">
                            {{ usuario.get_rol_display }}
                        </span>
                    </div>
                    <div>
                        <strong style="color: #1B3C53;">Estado Actual:</strong><br>
                        <span style="color: {% if usuario.activo %}#28a745{% else %}#dc3545{% endif %}; font-weight: bold;">
                            {% if usuario.activo %}Activo{% else %}Inactivo{% endif %}
                        </span>
                    </div>
                    <div>
                        <strong style="color: #1B3C53;">Fecha de Registro:</strong><br>
                        <span style="color: #666;">{{ usuario.date_joined|date:"d/m/Y" }}</span>
                    </div>
                    <div>
                        <strong style="color: #1B3C53;">Último Acceso:</strong><br>
                        <span style="color: #666;">
                            {% if usuario.last_login %}
                                {{ usuario.last_login|date:"d/m/Y H:i" }}
                            {% else %}
                                Nunca
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Advertencias según el rol -->
            {% if usuario.rol == 'estudiante' %}
            <div style="background-color: #e7f3ff; border-left: 5px solid #0066cc; padding: 1.5rem; border-radius: 5px; margin-bottom: 2rem;">
                <h5 style="color: #003d7a; margin-bottom: 1rem;"> Impacto en Datos del Estudiante</h5>
                <ul style="margin: 0; padding-left: 1.5rem; color: #003d7a;">
                    <li><strong>{{ inscripciones_activas }}</strong> inscripción(es) activa(s) serán <strong>desactivadas</strong></li>
                    <li><strong>{{ calificaciones_count }}</strong> calificación(es) se <strong>mantendrán</strong> en el historial</li>
                    <li>El estudiante <strong>no podrá acceder</strong> al sistema</li>
                    <li>Sus datos históricos <strong>se preservarán</strong> para consultas futuras</li>
                    <li>Puede ser <strong>reactivado</strong> posteriormente editando su estado</li>
                </ul>
            </div>
            {% elif usuario.rol == 'profesor' %}
            <div style="background-color: #fff3e0; border-left: 5px solid #ff9800; padding: 1.5rem; border-radius: 5px; margin-bottom: 2rem;">
                <h5 style="color: #e65100; margin-bottom: 1rem;"> Impacto en Cursos del Profesor</h5>
                <ul style="margin: 0; padding-left: 1.5rem; color: #e65100;">
                    <li><strong>{{ cursos_asignados }}</strong> curso(s) activo(s) quedarán <strong>SIN PROFESOR</strong> asignado</li>
                    <li><strong>{{ calificaciones_registradas }}</strong> calificación(es) registradas se <strong>mantendrán</strong></li>
                    <li>Se recomienda <strong>reasignar los cursos</strong> antes de eliminar al profesor</li>
                    <li>El profesor <strong>no podrá acceder</strong> al sistema</li>
                    <li>Puede ser <strong>reactivado</strong> posteriormente editando su estado</li>
                </ul>
                
                {% if cursos_asignados > 0 %}
                <div style="background-color: #fff; padding: 1rem; border-radius: 5px; margin-top: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="confirmarProfesor" value="confirmo" style="width: 20px; height: 20px;">
                        <span style="font-weight: bold; color: #e65100;">
                            Confirmo que deseo desactivar este profesor a pesar de tener cursos asignados
                        </span>
                    </label>
                </div>
                {% endif %}
            </div>
            {% elif usuario.rol == 'administrador' %}
            <div style="background-color: #ffebee; border-left: 5px solid #dc3545; padding: 1.5rem; border-radius: 5px; margin-bottom: 2rem;">
                <h5 style="color: #721c24; margin-bottom: 1rem;">Advertencia: Desactivación de Administrador</h5>
                <ul style="margin: 0; padding-left: 1.5rem; color: #721c24;">
                    <li>Este usuario tiene permisos de <strong>Administrador</strong></li>
                    <li>Asegúrate de que existan <strong>otros administradores activos</strong> en el sistema</li>
                    <li>El sistema no permitirá desactivar el <strong>último administrador activo</strong></li>
                    <li>Puede ser <strong>reactivado</strong> posteriormente editando su estado</li>
                </ul>
            </div>
            {% endif %}
            
            <!-- Formulario de eliminación -->
            <form method="post" id="formEliminar">
                {% csrf_token %}
                
                <div class="form-group">
                    <label for="motivo" style="font-weight: bold; font-size: 1.1rem; color: #1B3C53;">
                        Motivo de Eliminación (obligatorio):
                    </label>
                    <textarea name="motivo" 
                              id="motivo" 
                              class="form-control" 
                              rows="5" 
                              required 
                              minlength="10"
                              maxlength="300"
                              placeholder="Explique por qué se está desactivando este usuario (mínimo 10 caracteres, máximo 300)..."
                              style="resize: vertical; border: 2px solid #6B9BD1;"></textarea>
                    <small style="color: #666; display: block; margin-top: 0.5rem;">
                        Caracteres: <span id="contador" style="font-weight: bold;">0</span> / 300
                    </small>
                </div>
                
                {% if usuario.rol == 'profesor' and cursos_asignados > 0 %}
                <input type="hidden" name="confirmacion_profesor" id="confirmacionProfesor" value="">
                {% endif %}
                
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2.5rem; flex-wrap: wrap;">
                    <button type="submit" class="btn btn-danger" style="padding: 1rem 3rem; font-size: 1.1rem;" id="btnEliminar">
                         Desactivar Usuario
                    </button>
                    <a href="{% url 'admin_usuarios_lista' %}" 
                       class="btn btn-secondary" style="padding: 1rem 3rem; font-size: 1.1rem;">
                         Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Contador de caracteres
    document.getElementById('motivo').addEventListener('input', function() {
        const contador = document.getElementById('contador');
        contador.textContent = this.value.length;
        
        if (this.value.length < 10) {
            contador.style.color = '#dc3545';
        } else if (this.value.length > 250) {
            contador.style.color = '#ffc107';
        } else {
            contador.style.color = '#28a745';
        }
    });
    
    // Validación de confirmación para profesor con cursos
    {% if usuario.rol == 'profesor' and cursos_asignados > 0 %}
    document.getElementById('confirmarProfesor').addEventListener('change', function() {
        document.getElementById('confirmacionProfesor').value = this.checked ? 'confirmo' : '';
    });
    {% endif %}
    
    // Confirmación final antes de enviar
    document.getElementById('formEliminar').addEventListener('submit', function(e) {
        const motivo = document.getElementById('motivo').value.trim();
        
        if (motivo.length < 10) {
            e.preventDefault();
            alert('El motivo debe tener al menos 10 caracteres.');
            return false;
        }
        
        {% if usuario.rol == 'profesor' and cursos_asignados > 0 %}
        const confirmacionProfesor = document.getElementById('confirmarProfesor').checked;
        if (!confirmacionProfesor) {
            e.preventDefault();
            alert('Debe confirmar que desea desactivar al profesor con cursos asignados.');
            return false;
        }
        {% endif %}
        
        const confirmacion = confirm(
            '⚠️ CONFIRMACIÓN FINAL ⚠️\n\n' +
            '¿Está completamente seguro de desactivar este usuario?\n\n' +
            '• Usuario: {{ usuario.username }}\n' +
            '• Nombre: {{ usuario.first_name }} {{ usuario.last_name }}\n' +
            '• Rol: {{ usuario.get_rol_display }}\n\n' +
            'El usuario será DESACTIVADO y no podrá acceder al sistema.\n' +
            'El historial del usuario se mantendrá.\n' +
            'Puede reactivarlo posteriormente editando su estado.\n\n' +
            'Presione OK para confirmar la desactivación.'
        );
        
        if (!confirmacion) {
            e.preventDefault();
            return false;
        }
    });
    
    // Foco automático en el textarea
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('motivo').focus();
    });
</script>
{% endblock %}
